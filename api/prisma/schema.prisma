generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Starter schema to validate migrations pipeline; will expand in later milestones.
model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jiraConnections JiraConnection[]
}

model JiraConnection {
  id             String    @id @default(cuid())
  userId         String
  cloudId        String
  siteName       String
  siteUrl        String
  accessTokenEnc String
  refreshTokenEnc String?
  scopes         String[]
  tokenType      String
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  boards     JiraBoard[]
  sprints    JiraSprint[]
  issues     JiraIssue[]
  assignees  JiraAssignee[]
  syncJobs   JiraSyncJob[]
}

model JiraBoard {
  id           String   @id @default(cuid())
  connectionId String
  jiraId       String
  name         String
  type         String?
  isPrivate    Boolean?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  connection JiraConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  sprints    JiraSprint[]
  issues     JiraIssue[]

  @@unique([connectionId, jiraId])
  @@index([connectionId])
}

model JiraSprint {
  id           String   @id @default(cuid())
  connectionId String
  boardId      String
  jiraId       String
  name         String
  state        String
  startDate    DateTime?
  endDate      DateTime?
  completeDate DateTime?
  goal         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  connection JiraConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  board      JiraBoard      @relation(fields: [boardId], references: [id], onDelete: Cascade)
  issues     JiraIssue[]

  @@unique([connectionId, jiraId])
  @@index([connectionId])
  @@index([boardId])
}

model JiraAssignee {
  id           String   @id @default(cuid())
  connectionId String
  accountId    String
  displayName  String
  email        String?
  avatarUrl    String?
  active       Boolean?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  connection JiraConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  issues     JiraIssue[]

  @@unique([connectionId, accountId])
  @@index([connectionId])
}

model JiraIssue {
  id             String   @id @default(cuid())
  connectionId   String
  boardId        String?
  sprintId       String?
  assigneeId     String?
  jiraId         String
  key            String
  summary        String
  issueType      String
  status         String
  statusCategory String?
  priority       String?
  storyPoints    Float?
  jiraCreatedAt  DateTime?
  jiraUpdatedAt  DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  connection JiraConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  board      JiraBoard?     @relation(fields: [boardId], references: [id], onDelete: SetNull)
  sprint     JiraSprint?    @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee   JiraAssignee?  @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  history    JiraIssueHistory[]

  @@unique([connectionId, jiraId])
  @@unique([connectionId, key])
  @@index([connectionId])
  @@index([boardId])
  @@index([sprintId])
  @@index([assigneeId])
}

model JiraIssueHistory {
  id             String   @id @default(cuid())
  issueId        String
  field          String
  fromValue      String?
  toValue        String?
  changedAt      DateTime
  authorAccountId String?
  createdAt      DateTime @default(now())

  issue JiraIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([changedAt])
}

model JiraSyncJob {
  id           String   @id @default(cuid())
  connectionId String
  jobType      String
  status       String
  startedAt    DateTime @default(now())
  finishedAt   DateTime?
  lastCursor   String?
  errorMessage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  connection JiraConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([status])
}
